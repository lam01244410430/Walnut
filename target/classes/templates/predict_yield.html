<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>产量预测 - 掌上核桃</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- Styles đồng bộ với Search Page --- */
        body { background-color: #f8f9fa; font-family: 'Microsoft YaHei', sans-serif; min-height: 100vh; display: flex; flex-direction: column; }

        .page-header {
            background: linear-gradient(135deg, #1b5e20 0%, #4caf50 100%);
            color: white;
            padding: 50px 0 80px;
            margin-bottom: 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .back-link {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            font-size: 0.95rem;
            transition: color 0.3s;
        }
        .back-link:hover { color: white; text-decoration: underline; }

        /* --- Content Cards --- */
        .content-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            margin-top: -50px; /* Đè lên header */
            position: relative;
            z-index: 10;
            border-top: 5px solid #ff9800; /* Màu cam cho năng suất */
            margin-bottom: 30px;
        }

        .prediction-number {
            font-size: 3.5rem;
            font-weight: 800;
            color: #2e7d32;
        }

        .prediction-label {
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
        }

        .form-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            height: 100%;
        }

        .btn-submit {
            background-color: #2e7d32;
            color: white;
            width: 100%;
            padding: 10px;
            border: none;
            font-weight: bold;
        }
        .btn-submit:hover { background-color: #1b5e20; color: white; }
    </style>
</head>
<body>

<div class="page-header text-center">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <a href="/" class="back-link"><i class="fas fa-arrow-left me-2"></i>返回首页 (Home)</a>
            <span class="badge bg-white text-success bg-opacity-25"
                  th:text="${farmer != null ? 'FARMER: ' + farmer.getName : 'Guest'}">User</span>
        </div>
        <h1 class="fw-bold"><i class="fas fa-chart-line me-3"></i>产量预测与分析</h1>
        <p class="opacity-75">基于历史数据智能预测下一季产量</p>
    </div>
</div>

<div class="container pb-5">

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="content-card text-center">
                <p class="prediction-label">下一季预计产量 (Predicted Yield)</p>
                <div class="prediction-number">
                    <i class="fas fa-arrow-up text-success fs-3 me-2"></i>
                    <span th:text="${predictedYield}">0</span>
                    <span class="fs-4 text-muted">kg</span>
                </div>
                <p class="text-muted mt-2 mb-0"><small>* 基于您的历史数据增长趋势预测 (Based on +5% trend)</small></p>
            </div>
        </div>
    </div>

    <div class="row justify-content-center g-4">

        <div class="col-lg-4">
            <div class="form-card">
                <h5 class="fw-bold mb-4 text-secondary"><i class="fas fa-edit me-2"></i>录入新数据 (Add Data)</h5>

                <form action="/add-production-data" method="post">
                    <div class="mb-3">
                        <label class="form-label">年份 (Year)</label>
                        <input type="number" name="year" class="form-control" placeholder="Enter year..." required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">实际产量 (Yield - kg)</label>
                        <input type="number" step="0.1" name="yield" class="form-control" placeholder="Enter mount of kg..." required>
                    </div>
                    <button type="submit" class="btn btn-submit rounded-3">
                        <i class="fas fa-save me-2"></i>保存数据 (Save)
                    </button>
                </form>

                <hr class="my-4">
                <div class="alert alert-info small mb-0">
                    <i class="fas fa-info-circle me-1"></i> 数据越多，预测越准确。
                    <br>(More data leads to better predictions)
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="form-card">
                <h5 class="fw-bold mb-3 text-secondary"><i class="fas fa-chart-bar me-2"></i>历史产量趋势 (History)</h5>
                <canvas id="yieldChart"></canvas>
            </div>
        </div>
    </div>
</div>

<footer class="bg-dark text-white text-center py-3 mt-auto">
    <div class="container">
        <small>&copy; 2025 掌上核桃 (Walnut App). All Rights Reserved.</small>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    /* Lấy dữ liệu từ Controller thông qua Thymeleaf */
    var years = /*[[${chartYears}]]*/ [];
    var yields = /*[[${chartYields}]]*/ [];

    if (years && years.length > 0) {
        const ctx = document.getElementById('yieldChart').getContext('2d');
        new Chart(ctx, {
            type: 'line', // Dạng biểu đồ đường
            data: {
                labels: years,
                datasets: [{
                    label: '产量 (kg)',
                    data: yields,
                    borderColor: '#2e7d32', // Màu đường kẻ (Xanh lá đậm)
                    backgroundColor: 'rgba(46, 125, 50, 0.1)', // Màu nền dưới đường kẻ
                    borderWidth: 2,
                    pointBackgroundColor: '#ff9800', // Màu điểm (Cam)
                    pointRadius: 4,
                    fill: true,
                    tension: 0.3 // Độ cong của đường
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: '产量 (kg)' }
                    },
                    x: {
                        title: { display: true, text: '年份 (Year)' }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }
</script>
</body>
</html>